!function(){"use strict";function e(e,r,t,i,n,o,s,l,a,d){function c(e){return 0!==BrowserHandler.runtime.getURL("").search(new RegExp(e.origin,"i"))?void i.error(String.format("BackgroundController.receiveMessage: Error processing message with unrecognized origin {0}",e.origin)):"[object File]"!==Object.prototype.toString.call(e.data)?void i.error(String.format("BackgroundController.receiveMessage: Error processing message with event.data type {0}",Object.prototype.toString.call(e.data))):void p(e.data,function(e){Utilities.isUndefinedOrNull(e)||I(e,null)})}function u(e){Utilities.isUndefinedOrNull(e)&&(e=n.LINKS.PROGRESSPAGE_URL);var r=t.defer();return BrowserHandler.windows.getAll(function(t){0===t.length?BrowserHandler.windows.create({url:e,type:"normal"},function(e){r.resolve(e.tabs[0].id)}):BrowserHandler.tabs.create({url:e},function(e){r.resolve(e.id)})}),r.promise}function f(e,r){if(Utilities.isUndefinedOrNull(e))return void r(null);for(var t=0;t<e.length;++t)e[t].file(function(e){p(e,function(e){r(e)})})}function p(e,r){return Utilities.isUndefinedOrNull(e)?void r(null):void a.upload(e,n.FILE.ORIGIN.HTML5,function(e){r(e)})}function I(e,r){var n=t.defer();n.resolve(Utilities.isNotUndefinedOrNull(r)?r:u(e)),n.promise.then(function(r){return Utilities.isUndefinedOrNull(r)?void i.warn(String.format("BackgroundController.openFileUrlInTab(): tabIdPromise null or undefined")):void BrowserHandler.tabs.update(r,{url:e})})}var g;BrowserHandler.webRequest.onSendHeaders.addListener(function(e){if("main_frame"===e.type)for(var r=0;r<e.requestHeaders.length;++r)if("Referer"===e.requestHeaders[r].name)return void(g=0===e.requestHeaders[r].value.indexOf("https://view.officeapps.live.com")?null:e.tabId)},{urls:["*://*/*.doc","*://*/*.doct","*://*/*.docx","*://*/*.dotx","*://*/*.odt","*://*/*.ppt","*://*/*.pot","*://*/*.pps","*://*/*.pptx","*://*/*.ppsx","*://*/*.odp","*://*/*.xls","*://*/*.xlsx","*://*/*.xlsm","*://*/*.xlsb","*://*/*.ods"]},["requestHeaders"]),BrowserHandler.webRequest.onHeadersReceived.addListener(function(e){if("main_frame"===e.type&&!(Utilities.isUndefinedOrNull(e.responseHeaders)||Utilities.isUndefinedOrNull(g)||Utilities.isUndefinedOrNull(e.tabId)||g!==e.tabId)){for(var r={},t=0;t<e.responseHeaders.length;++t)r[e.responseHeaders[t].name]=e.responseHeaders[t].value;if(!r["Cache-Control"]||-1===r["Cache-Control"].indexOf("private"))return r["Content-Type"]?n.FILE.OFFICE_MIME_TYPES[r["Content-Type"].toLowerCase()]?(i.trackEvent("OpenDocument_BrowserWebDocument"),{redirectUrl:"https://view.officeapps.live.com/op/view.aspx?src="+e.url}):void i.warn(String.format("onHeadersReceived called with Content-Type {0}",r["Content-Type"])):void 0}},{urls:["*://*/*.doc","*://*/*.doct","*://*/*.docx","*://*/*.dotx","*://*/*.odt","*://*/*.ppt","*://*/*.pot","*://*/*.pps","*://*/*.pptx","*://*/*.ppsx","*://*/*.odp","*://*/*.xls","*://*/*.xlsx","*://*/*.xlsm","*://*/*.xlsb","*://*/*.ods"]},["responseHeaders","blocking"]),BrowserHandler.webRequest.onBeforeRequest.addListener(function(e){if("main_frame"===e.type){i.trackEvent("OpenDocument_BrowserDragAndDrop");var r=e.tabId;return a.upload(e.url,n.FILE.ORIGIN.LOCAL_PATH,function(e){Utilities.isUndefinedOrNull(e)||I(e,r)}),{redirectUrl:n.LINKS.PROGRESSPAGE_URL}}},{urls:["file:///*.doc","file:///*.doct","file:///*.docx","file:///*.dotx","file:///*.odt","file:///*.ppt","file:///*.pot","file:///*.pps","file:///*.pptx","file:///*.ppsx","file:///*.odp","file:///*.xlsx","file:///*.xlsm","file:///*.xlsb","file:///*.ods"]},["blocking"]),BrowserHandler.webRequest.onErrorOccurred.addListener(function(e){i.error(String.format("BackgroundWebRequestOnErrorOccured - {0}",e.error))},{urls:["file:///*.doc","file:///*.doct","file:///*.docx","file:///*.dotx","file:///*.odt","file:///*.ppt","file:///*.pot","file:///*.pps","file:///*.pptx","file:///*.ppsx","file:///*.odp","file:///*.xlsx","file:///*.xlsm","file:///*.xlsb","file:///*.ods"]}),BrowserHandler.runtime.onInstalled.addListener(function(e){var r=Utilities.getManifest(),t=r?r.version:-1;"install"===e.reason?(i.trackEvent(String.format("AppInstalled_{0}",t)),o.show(n.NOTIFICATION.FILEACCESS),BrowserHandler.runtime.getPlatformInfo(function(e){"cros"===e.os&&o.show(n.NOTIFICATION.SETDEFAULT)})):"update"===e.reason&&(i.trackEvent(String.format("AppUpdated_{0}",t),{previousVersion:e.previousVersion}),Utilities.isNotUndefinedOrNull(window.localStorage.getItem(n.OAUTH.SERVICE_ID))&&(s.clear(),window.localStorage.clear()),s.get("userInfo").then(function(e){Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.userInfo)&&(Utilities.isNotUndefinedOrNull(e.userInfo.id)||Utilities.isNotUndefinedOrNull(e.userInfo.profile))&&(s.clear(),window.localStorage.clear())}))}),BrowserHandler.notifications.onButtonClicked.addListener(function(e){switch(e){case n.NOTIFICATION.AUTOSAVE.id:s.set({displayAutoSaveNotification:!1})}}),BrowserHandler.notifications.onClicked.addListener(function(e){switch(e){case n.NOTIFICATION.FILEACCESS.id:BrowserHandler.tabs.create({url:n.LINKS.SETTINGS_URL});break;case n.NOTIFICATION.INVALIDSUBSCRIPTION.id:BrowserHandler.tabs.create({url:n.LINKS.OFFICE_URL})}}),BrowserHandler.runtime.onMessage.addListener(function(e){switch(i.debug(String.format("BackgroundController.onMessage: Processing request activity {0}",e.activity)),e.activity){case n.ACTIVITY.TELEMETRY.NAME:switch(e.command){case n.TELEMETRY.COMMAND.SET_DISABLED:i.setEnabledSetting(e.enabled);break;case n.TELEMETRY.COMMAND.TRACK_EVENT:i.trackEvent(e.eventName,e.properties,e.measurements);break;case n.TELEMETRY.COMMAND.TRACK_TRACE:i.trackTrace(e.message,e.properties)}break;case n.ACTIVITY.NOTIFICATION.NAME:o.show(e.notification);break;case n.ACTIVITY.AUTHENTICATION.NAME:l.login(e.type);break;case n.ACTIVITY.AUTHORIZATION.NAME:BrowserHandler.tabs.query({active:!0,lastFocusedWindow:!0},function(r){if(Utilities.isUndefinedOrNull(r)||Utilities.isUndefinedOrNull(r[0]))return void i.error(String.format("BackgroundController.onMessage: Error processing request activity {0}; active tab undefined or null",e.activity));var t=r[0];s.get("loginTabId").then(function(r){if(Utilities.isUndefinedOrNull(r.loginTabId)||r.loginTabId!==t.id)return void i.error(String.format("BackgroundController.onMessage: Processing request activity {0}; loginTabId undefined or null or different from storage",e.activity));s.remove("loginTabId"),BrowserHandler.tabs.remove(t.id);var o=Utilities.deserializeQuery(e.query);o.hasOwnProperty(n.OAUTH.CODE)&&l.authenticate(e.type,o.code)})})}}),Utilities.isChrome()&&(BrowserHandler.runtime.onMessageExternal.addListener(function(e,r,t){switch(e.command){case n.COPY_PASTE.TEST:return d.handleTestCommand(e,r,t);case n.COPY_PASTE.COPY:return d.handleCopyCommand(e,r,t);case n.COPY_PASTE.PASTE:return d.handlePasteCommand(e,r,t);default:return!1}}),e.addEventListener("paste",d.onPasteEvent)),BrowserHandler.tabs.onReplaced.addListener(function(e,r){s.set({loginTabId:e})}),BrowserHandler.runtime.getPlatformInfo(function(e){"cros"===e.os&&BrowserHandler.fileBrowserHandler.onExecute.addListener(function(e,r){var t=r.entries;f(t,function(e){Utilities.isUndefinedOrNull(e)||I(e,null)})})}),window.addEventListener("message",c,!1)}angular.module("app.background",[]).controller("BackgroundController",["$window","$http","$q","$log","constants","notification","storage","userService","fileService","copyPasteService",e])}();