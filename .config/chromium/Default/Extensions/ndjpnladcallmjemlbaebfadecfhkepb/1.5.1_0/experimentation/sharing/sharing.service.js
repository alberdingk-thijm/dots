!function(){"use strict";function e(e,r,i,n,t){function s(e,r){if(!Utilities.isUndefinedOrNull(e)&&!Utilities.isUndefinedOrNull(e.url)&&(e.shareUrl="",r===n.USER_TYPE.MSA)){var i=e.url,t=i.replace("&page=view","&page=self");t.indexOf("&page=self")<0&&(t+="&page=self"),t+="&action=share",e.shareUrl=t}}function l(e,t){var s=r.defer();if(Utilities.isUndefinedOrNull(e))return s.resolve(),s.promise;if(t===n.USER_TYPE.MSA){var l=function(r){i.error(String.format("sharingService.setFlagFromPermissions error: {0}",r)),e.canBeShared=!1,s.resolve()};return o(e).then(function(r){e.canBeShared=r,s.resolve()},l),s.promise}return e.canBeShared=!1,s.resolve(),s.promise}function o(i){var t=r.defer();return u().then(function(r){if(Utilities.isUndefinedOrNull(r))return t.reject("null cid"),t.promise;if(Utilities.isUndefinedOrNull(i.id))return t.reject("no document id"),t.promise;var s=i.id.split("."),l=s[s.length-1],o={method:"GET",url:n.MSACONFIG.ONEDRIVE_ITEMS_URL+l+"/permissions",headers:{"X-UserType":n.USER_TYPE.MSA}};e(o).success(function(e){var i=a(e,r);t.resolve(i)}).error(function(e){t.reject(e)})}),t.promise}function u(){var e=r.defer();return t.waitForUserInfo(n.USER_TYPE.MSA).then(function(r){return Utilities.isUndefinedOrNull(r)?(e.resolve(null),e.promise):void e.resolve(r.cid)}),e.promise}function a(e,r){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e.value))return!0;for(var i=!0,n=r.substring(1,r.length),t=0;t<e.value.length;++t){var s=e.value[t];if(!Utilities.isUndefinedOrNull(s.grantedTo)){var l=s.grantedTo.user;if(l.id===r||l.id===n){var o=s.roles;i=o.toString().toLowerCase().indexOf("write")>-1}}}return i}var f={setShareUrl:s,setFlagFromPermissions:l};return f}angular.module("app.experimentation").factory("sharingService",["$http","$q","$log","constants","userService",e])}();