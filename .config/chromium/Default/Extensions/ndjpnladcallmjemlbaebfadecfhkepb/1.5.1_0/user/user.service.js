!function(){"use strict";function e(e,r,t,n,i,o,s,u){function l(e,o,s,u){3===arguments.length&&"[object Function]"===Object.prototype.toString.call(s)?(u=s,s=null):2===arguments.length&&"[object Function]"===Object.prototype.toString.call(o)&&(u=o,o=null);var l=p(e);if(Utilities.isUndefinedOrNull(l))return r.error("userService.acquireToken - Invalid type"),void u(null);var c=l.getConfig();c.params.grant_type=n.OAUTH.REFRESH_TOKEN,4!==arguments.length&&3!==arguments.length||l.type!==n.USER_TYPE.O365||(Utilities.isUndefinedOrNull(s)?c.resource=l.getResourceForEndpoint(o):c.resource=s,c.params.resource=c.resource),m(c.resource,function(e){return Utilities.isNotUndefinedOrNull(e)?void u(e):void g(l.type,function(e){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(e))return void u(null);c.params.refresh_token=e;var r=t.get("$http"),n={method:"POST",url:c.url,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:$.param(c.params)};r(n).success(function(e){I(c.resource,e),O(l.type,e),i.set({userType:l.type}),u(e.access_token)}).error(function(){a(),u(null)})})})}function c(e,o,s){var u=e.getConfig();if(Utilities.isUndefinedOrNull(e))return r.error("userService.acquireTokenFromCode - Invalid type"),void s(null);u.params.grant_type=n.OAUTH.AUTH_CODE,u.params.code=o;var l=t.get("$http"),c={method:"POST",url:u.url,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},data:$.param(u.params)};l(c).success(function(r){I(u.resource,r),O(e.type,r),i.set({userType:e.type}),_(e.type,r),s(r.access_token)}).error(function(){s(null)})}function f(e,t){var i=p(e);return Utilities.isUndefinedOrNull(i)?void r.error("userService.authenticate - Invalid type"):void c(i,t,function(e){return Utilities.isUndefinedOrNull(e)?void(i.type===n.USER_TYPE.O365&&o.show(n.NOTIFICATION.INVALIDSUBSCRIPTION)):void r.trackEvent(String.format("Authorization_Success_{0}",i.type))})}function a(){i.remove("accessToken"),i.remove("refreshToken"),i.remove("userInfo"),i.remove("userType")}function d(e){i.get("userType").then(function(r){return Utilities.isUndefinedOrNull(r.userType)?void e(!1):void l(r.userType,function(r){e(Utilities.isNotUndefinedOrNull(r))})})}function U(){var r=e.defer();return d(function(e){return e?void i.get("userType").then(function(e){Utilities.isUndefinedOrNull(e.userType)?r.resolve(n.USER_TYPE.NONE):r.resolve(e.userType)}):(r.resolve(n.USER_TYPE.NONE),r.promise)}),r.promise}function v(e){var t=p(e);return Utilities.isUndefinedOrNull(t)?void r.error("userService.login - Invalid type"):void BrowserHandler.tabs.create({url:t.getConfig().loginUrl},function(e){i.set({loginTabId:e.id})})}function T(e){a();var n=p(e);if(Utilities.isUndefinedOrNull(n))return void r.error("userService.logout - Invalid type");var i=t.get("$http"),o={method:"GET",url:n.getConfig().logoutUrl};i(o).success(function(){r.debug(String.format("userService.logout - {0}",e))})}function p(e){var t=null;switch(e){case n.USER_TYPE.MSA:t=s;break;case n.USER_TYPE.O365:t=u;break;default:r.error(String.format("userService.getUserServiceProvider - Invalid type - {0}",e))}return t}function g(e,r){i.get("refreshToken").then(function(t){return Utilities.isUndefinedOrNull(t.refreshToken)||Utilities.isUndefinedOrNull(t.refreshToken[e])?void r(null):void r(t.refreshToken[e])})}function O(e,r){i.get("refreshToken").then(function(t){Utilities.isUndefinedOrNull(t.refreshToken)&&(t.refreshToken={}),t.refreshToken[e]=r.refresh_token,i.set(t)})}function m(e,r){i.get("accessToken").then(function(t){return Utilities.isUndefinedOrNull(t.accessToken)||Utilities.isUndefinedOrNull(t.accessToken[e])?void r(null):E(t.accessToken[e].expires_on)?void r(null):void r(t.accessToken[e].access_token)})}function I(e,r){Utilities.isUndefinedOrNull(r.expires_on)&&(r.expires_on=Utilities.getCurrentTime()+r.expires_in),i.get("accessToken").then(function(t){Utilities.isUndefinedOrNull(t.accessToken)&&(t.accessToken={}),t.accessToken[e]=r,i.set(t)})}function N(e,r){i.get("userInfo").then(function(t){return Utilities.isUndefinedOrNull(t.userInfo)||Utilities.isUndefinedOrNull(t.userInfo[e])?void r(null):void r(t.userInfo[e])})}function h(t){var i=e.defer();return R.getUserInfo(t,function(e){function o(e){e.activity===n.ACTIVITY.USERINFO_AVAILABLE.NAME&&(BrowserHandler.runtime.onMessage.removeListener(o),clearTimeout(u),i.resolve(e.data))}if(Utilities.isNotUndefinedOrNull(e))return i.resolve(e),i.promise;BrowserHandler.runtime.onMessage.addListener(o);var s=Utilities.isExtensionInTestingMode()?n.TIMEOUT.USER_INFO_LOOKUP_TEST:n.TIMEOUT.USER_INFO_LOOKUP,u=setTimeout(function(){r.warn(String.format("userService.waitForUserInfo timed out after {0} ms - {1}",n.TIMEOUT.USER_INFO_LOOKUP,t)),BrowserHandler.runtime.onMessage.removeListener(o),i.resolve(e)},s)}),i.promise}function S(r,t){var n=e.defer();return i.get("userInfo").then(function(e){Utilities.isUndefinedOrNull(e.userInfo)&&(e.userInfo={}),e.userInfo[r]={},e.userInfo[r].email=t.email,e.userInfo[r].puid=t.puid,e.userInfo[r].cid=t.cid,e.userInfo[r].serviceInfo=t.serviceInfo,e.userInfo[r].flights=t.flights,e.userInfo[r].features=t.features,e.userInfo[r].photo=t.photo,i.set(e),n.resolve(e.userInfo[r])}),n.promise}function E(e){var r=Utilities.getCurrentTime(),t=120;return e&&e>r+t?!1:!0}function _(e,r){var t=p(e);t.lookupUserInfo(r,function(r){BrowserHandler.runtime.sendMessage({activity:n.ACTIVITY.USERINFO_AVAILABLE.NAME,data:r}),S(e,r),k(e,r)})}function y(){var t=e.defer();return R.getUserType().then(function(e){return e===n.USER_TYPE.NONE?(r.warn("UserService.getUserPhoto: no signed-in user"),t.reject(n.RECENTS.ERROR.UNSUPPORTED_USER_TYPE),t.promise):void R.getUserInfo(e,function(n){return Utilities.isNotUndefinedOrNull(n)&&Utilities.isNotUndefinedOrNull(n.photo)?(r.trackEvent(String.format("UserService_GotLocalPhoto_{0}",e)),t.resolve(n.photo),t.promise):void R.getPhotoFromServer(e,n).then(function(e){t.resolve(e)},function(e){t.reject(e)})})}),t.promise}function k(i,o){var s=e.defer(),u=t.get("$http");if(i===n.USER_TYPE.O365&&(Utilities.isUndefinedOrNull(o)||Utilities.isUndefinedOrNull(o.email)))return s.reject(),s.promise;var l=i===n.USER_TYPE.MSA?n.MSACONFIG.PHOTO_URL:String.format(n.O365CONFIG.PHOTO_URL,o.email),c={method:"GET",url:l,responseType:"blob",headers:{"X-UserType":i}};return u(c).success(function(e){r.trackEvent(String.format("UserService_GotServerPhoto_{0}",i));var t=new FileReader;t.onload=function(){N(i,function(e){Utilities.isNotUndefinedOrNull(e)&&(e.photo=t.result,S(i,e))}),s.resolve(t.result)},t.readAsDataURL(e)}).error(function(e){s.reject(e)}),s.promise}var R={acquireToken:l,authenticate:f,clearToken:a,getLoginStatus:d,getUserType:U,getUserInfo:N,waitForUserInfo:h,saveUserInfo:S,login:v,logout:T,getUserPhoto:y,getPhotoFromServer:k,lookupUserInfo:_};return R}angular.module("app.user",[]).factory("userService",["$q","$log","$injector","constants","storage","notification","msaUserService","o365UserService",e])}();