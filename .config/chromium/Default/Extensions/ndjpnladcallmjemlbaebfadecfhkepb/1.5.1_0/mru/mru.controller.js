!function(){"use strict";function e(e,t,n,i,s,r){function o(){n.debug("Loading MruController"),l.currentDisplayPanel=l.constants.RECENTS.DISPLAY_PANEL.LOADING,l.getRecentDocumentsFromStorage().then(function(e){!Utilities.isUndefinedOrNull(e)&&e.length>0&&(l.recentDocuments=e,l.currentDisplayPanel=l.constants.RECENTS.DISPLAY_PANEL.LIST)})}function c(e,t){n.trackEvent("PopupOpenRecentDocument_"+e.application),Utilities.navigateToUrlWithNewTab(e.url,Utilities.isUndefinedOrNull(t)||Utilities.isUndefinedOrNull(t.ctrlKey)?!0:!t.ctrlKey),window.close()}var l=this;l.onLoad=o,l.openRecentDocument=c,l.constants=i,l.storage=s,l.currentDisplayPanel=l.constants.RECENTS.DISPLAY_PANEL.LOADING,l.recentDocuments=[],e.$watch("userType",function(e){e!==l.constants.USER_TYPE.NONE&&l.refreshRecentDocumentsList().then(function(){l.currentDisplayPanel=!Utilities.isUndefinedOrNull(l.recentDocuments)&&l.recentDocuments.length>0?l.constants.RECENTS.DISPLAY_PANEL.LIST:l.constants.RECENTS.DISPLAY_PANEL.NO_DOCS},function(e){n.debug(String.format("MruController $scope.$watch error on refreshRecentDocumentsList: {0}",e)),l.currentDisplayPanel=!Utilities.isUndefinedOrNull(l.recentDocuments)&&l.recentDocuments.length>0?l.constants.RECENTS.DISPLAY_PANEL.LIST:l.constants.RECENTS.DISPLAY_PANEL.ERROR})}),this.refreshRecentDocumentsList=function(){var e=t.defer();return n.debug("MruController.refreshRecentDocumentsList(): Method start"),r.getRecentDocumentList().then(function(t){Utilities.isUndefinedOrNull(t)&&(t=[]);for(var i=[],s=0,r=0;r<t.length&&s<l.constants.RECENTS.LIST_LENGTH;r++)Utilities.isUndefinedOrNull(t[r].Application)?n.warn(String.format("Undefined document application with document type {0}",Utilities.getFileExtension(t[r].FileName))):l.isFileDataValid(t[r].FileName,t[r].Application,t[r].DocumentUrl,t[r].Timestamp)&&(i.push({appLabel:l.constants.FILE.APPLICATION_LABEL[t[r].Application.toLowerCase()],application:t[r].Application,lastAccessed:new Date(t[r].Timestamp).toLocaleDateString(),imageSource:"../"+l.constants.FILE.APPLICATION_IMAGE_PATH[t[r].Application.toLowerCase()],name:l.shortenFilename(t[r].FileName),url:l.createOpenInWebUrl(t[r].DocumentUrl),id:t[r].Id}),s++);l.mruListsEqual(l.recentDocuments,i)||(l.recentDocuments=i,l.setRecentDocumentsToStorage(i)),e.resolve()},function(t){e.reject(t)}),e.promise},this.mruListsEqual=function(e,t){if(Utilities.isUndefinedOrNull(e)||Utilities.isUndefinedOrNull(t)||e.length!==t.length)return!1;for(var n=0;n<t.length;n++)if(t[n].name!==e[n].name||t[n].url!==e[n].url||t[n].lastAccessed!==e[n].lastAccessed)return!1;return!0},this.getRecentDocumentsFromStorage=function(){var e=t.defer();return s.get("localRecentDocuments").then(function(t){e.resolve(t.localRecentDocuments)}),e.promise},this.setRecentDocumentsToStorage=function(e){s.set({localRecentDocuments:e})},this.isFileDataValid=function(e,t,n,i){return Utilities.isUndefinedOrNull(t)||!l.constants.FILE.APPLICATION_LABEL[t.toLowerCase()]?!1:Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(n)&&Utilities.isNotUndefinedOrNull(i)},this.createOpenInWebUrl=function(e){return l.constants.FILE.SUPPORTED_FILE_TYPES[Utilities.getFileExtension(e)]?e+"?web=1":e},this.shortenFilename=function(e){var t=e.replace(/\.[^\/.]+$/,"");return t}}angular.module("app.mru").controller("MruController",["$scope","$q","$log","constants","storage","mruService",e])}();