!function(){"use strict";function e(e,r,n,o){function t(t){var u=r.get("$http"),a={method:"GET",url:n.O365CONFIG.DISCOVERY_URL,headers:{"X-UserType":n.USER_TYPE.O365}};u(a).success(function(r){for(var u=0;u<r.value.length;++u)if("MyFiles"===r.value[u].capability&&"v2.0"===r.value[u].serviceApiVersion){var a={};return a.resource=r.value[u].serviceResourceId,a.url=r.value[u].serviceEndpointUri,void t(a)}i(),o.show(n.NOTIFICATION.INVALIDSUBSCRIPTION),e.info(String.format("o365UserService.DiscoverServiceEndpoint - Invalid resource")),t(null)}).error(function(){i(),o.show(n.NOTIFICATION.INVALIDSUBSCRIPTION),t(null)})}function i(){var e=r.get("userService");e.clearToken()}function u(r){var o={},t=a(r);return t&&t.hasOwnProperty("aud")&&(t.aud.toLowerCase()===n.O365CONFIG.CLIENT_ID.toLowerCase()?(t.hasOwnProperty("upn")?o.email=t.upn:t.hasOwnProperty("email")&&(o.email=t.email),t.hasOwnProperty("puid")&&(o.puid=t.puid)):e.error("IdToken has invalid aud field")),o}function a(r){var n=l(r);if(!n)return null;try{var o=n.JWSPayload,t=s(o);return t?JSON.parse(t):(this._logstatus("The returned id_token could not be base64 url safe decoded."),null)}catch(i){e.error("The returned id_token could not be decoded: "+i.stack)}return null}function s(e){return e=e.replace(/-/g,"+").replace(/_/g,"/"),window.atob?decodeURIComponent(escape(window.atob(e))):null}function l(r){var n=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/,o=n.exec(r);if(!o||o.length<4)return e.error("The returned id_token is not parseable."),null;var t={header:o[1],JWSPayload:o[2],JWSSig:o[3]};return t}this.type=n.USER_TYPE.O365,this.getConfig=function(){var e={url:n.O365CONFIG.INSTANCE+"token",params:{client_id:n.O365CONFIG.CLIENT_ID,client_secret:n.O365CONFIG.CLIENT_SECRET,redirect_uri:n.O365CONFIG.REDIRECT_URI,resource:n.O365CONFIG.DISCOVERY_RESOURCE},resource:n.O365CONFIG.DISCOVERY_RESOURCE,loginUrl:n.O365CONFIG.INSTANCE+"authorize?response_type=code&client_id="+n.O365CONFIG.CLIENT_ID+"&redirect_uri="+n.O365CONFIG.REDIRECT_URI,logoutUrl:n.O365CONFIG.LOGOUT_URI};return e},this.getResourceForEndpoint=function(e){var r=null;if(Utilities.isUndefinedOrNull(e))return r;for(var o in n.O365CONFIG.ENDPOINTS)n.O365CONFIG.ENDPOINTS.hasOwnProperty(o)&&e.indexOf(o)>-1&&(r=n.O365CONFIG.ENDPOINTS[o]);return r},this.lookupUserInfo=function(e,r){var n=u(e.id_token);t(function(e){n.serviceInfo=e,r(n)})}}angular.module("app.user").service("o365UserService",["$log","$injector","constants","notification",e])}();