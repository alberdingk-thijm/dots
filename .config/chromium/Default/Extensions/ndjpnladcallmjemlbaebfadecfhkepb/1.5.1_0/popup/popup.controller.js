!function(){"use strict";function e(){return{require:"ngModel",restrict:"A",link:function(e,n,t,i){n.bind("change",function(e){i.$setViewValue(e.target.files)})}}}function n(e){return{require:"ngModel",restrict:"A",link:function(n,t,i,o){t.bind("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"}),t.bind("drop",function(n){n.stopPropagation(),n.preventDefault(),e.trackEvent("OpenDocument_Local_AppDragAndDrop"),o.$setViewValue(n.originalEvent.dataTransfer.files)})}}}function t(e,n){return{restrict:"A",link:function(t,i){i.bind("mousedown keydown keypress",function(t){(t.which===e.JQUERY.EVENT_ID.MOUSEDOWN.LEFT_BUTTON_CLICK||t.which===e.JQUERY.EVENT_ID.KEYPRESS.ENTER)&&(n.trackEvent("OpenDocument_Local"),angular.element(t.currentTarget).children("#file_picker").trigger("click"),t.preventDefault())})}}}function i(e,n,t,i,o,s,r,l,a,c){function u(){w.getSignInInfo(function(e){w.hasSignedIn=e,w.hasSignedIn===w.constants.SIGNINSTATUS.HASSIGNININFO&&I()}),i.getEnabledSetting().then(function(e){i.setEnabledSetting(e),w.telemetryInputChecked=e})}function d(){l.getUserPhoto().then(function(e){w.profilePicture=e},function(e){w.profilePicture="",i.error(String.format("PopupController.getUserPhoto: Profile Picture Error - {0}",e))})}function S(e){w.currentViewMode=w.currentViewMode===e?w.constants.MENU_VIEWMODE.NONE:w.currentViewMode=e}function I(){i.debug("PopupController.refreshSignInStatus(): Method start"),w.userService.getUserType().then(function(e){i.debug(String.format("PopupController.getSignInStatus(): hasSignedIn: {0}",e)),i.trackEvent("PopupSignedIn_"+e),n.userType=e,w.hasSignedIn=e===w.constants.USER_TYPE.NONE?w.constants.SIGNINSTATUS.NONE:w.constants.SIGNINSTATUS.SIGNEDIN,w.hasSignedIn===w.constants.SIGNINSTATUS.SIGNEDIN&&(w.userService.waitForUserInfo(e).then(function(e){return Utilities.isUndefinedOrNull(e)?void i.warn("self.UserService.getUserInfo(): userInfo is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):Utilities.isUndefinedOrNull(e.email)?void i.warn("self.UserService.getUserInfo(): userInfo.email is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN"):void(w.username=e.email)}),d())})}function p(){w.currentViewMode=w.constants.MENU_VIEWMODE.NONE,w.hasSignedIn===w.constants.SIGNINSTATUS.SIGNEDIN&&f()}function N(){i.trackEvent("PopupSignInLinkClick"),BrowserHandler.runtime.sendMessage({activity:w.constants.ACTIVITY.AUTHENTICATION.NAME,type:w.selectedUserType}),window.close()}function f(){i.trackEvent("PopupSignOutLinkClick"),w.userService.logout(n.userType),w.hasSignedIn=w.constants.SIGNINSTATUS.NONE,n.userType=w.constants.USER_TYPE.NONE,r.remove("localRecentDocuments")}function E(){i.trackEvent("PopupSignupLinkClick"),Utilities.navigateToUrlWithNewTab(w.constants.LINKS.SIGNUP,!0)}function g(){i.setEnabledSetting(w.telemetryInputChecked),i.trackEvent("PopupTelemetryInputChecked",{enabled:w.telemetryInputChecked})}function T(){Utilities.navigateToUrlWithNewTab(BrowserHandler.extension.getURL(w.constants.LINKS.FEEDBACK_URL),!0)}function U(){i.trackEvent("PopupOpenDocument_"+n.userType),w.userService.getUserInfo(n.userType,function(e){return Utilities.isUndefinedOrNull(e)?void i.warn("PopupController.openDocument(): invalid userInfo"):Utilities.isUndefinedOrNull(e.serviceInfo)||Utilities.isUndefinedOrNull(e.serviceInfo.resource)?void i.warn("PopupController.openDocument(): invalid serviceInfo"):void Utilities.navigateToUrlWithNewTab(e.serviceInfo.resource,!0)})}function v(){i.trackEvent("PopupBrowseToRecents_"+n.userType),w.userService.getUserInfo(n.userType,function(e){return Utilities.isUndefinedOrNull(e)?void i.warn("PopupController.browseToRecents(): invalid userInfo"):Utilities.isUndefinedOrNull(e.serviceInfo)||Utilities.isUndefinedOrNull(e.serviceInfo.resource)?void i.warn("PopupController.browseToRecents(): invalid serviceInfo"):void Utilities.navigateToUrlWithNewTab(String.format("{0}{1}",e.serviceInfo.resource,h()?"":"/?qt=mru"),!0)})}function O(e,n){i.trackEvent("PopupCreateDocument_"+e.id);var t;t="Sway"===e.id?w.hasSignedIn!==w.constants.SIGNINSTATUS.SIGNEDIN?w.constants.LINKS.APP.SWAY_DEFAULT:String.format(e.url,h()?"OrgId":"WindowsLiveId",w.username):String.format(e.url,w.hasSignedIn!==w.constants.SIGNINSTATUS.SIGNEDIN?"0":h()?"2":"1"),Utilities.navigateToUrlWithNewTab(t,Utilities.isUndefinedOrNull(n)||Utilities.isUndefinedOrNull(n.ctrlKey)?!0:!n.ctrlKey)}function P(){w.loadFile(),i.trackEvent("PopupFileInputChange")}function m(){return i.trackEvent("PopupLoadFile",{filesSelectedCount:w.filesSelected.length}),w.filesSelected.length>1&&i.warn(String.format("loadFile called with {0} files selected",w.filesSelected.length)),w.constants.FILE.SUPPORTED_FILE_TYPES[Utilities.getFileExtension(w.filesSelected[0].name)]?void C(w.filesSelected[0]):(i.info(String.format("PopupController.loadFile(): User attempted to open an unsupported file type of {0} extension",Utilities.getFileExtension(w.filesSelected[0].name))),void c.show(w.constants.NOTIFICATION.UNSUPPORTEDFILETYPE))}function h(){return n.userType===w.constants.USER_TYPE.O365}function C(e){BrowserHandler.extension.getBackgroundPage().postMessage(e,window.location)}var w=this;w.filesSelected=null,w.telemetryInputChecked=!1,w.onLine=!0,w.username="",w.profilePicture="",w.rtl=Utilities.isRTL(),w.isChrome=Utilities.isChrome(),w.onMenuItemClick=S,w.onAccountSignInClick=p,w.onWelcomeSignInClick=N,w.onSignOutLinkClick=f,w.onSignupLinkClick=E,w.onTelemetryInputChange=g,w.onFileInputChange=P,w.onFeedbackClick=T,w.openDocument=U,w.browseToRecents=v,w.createDocument=O,w.loadFile=m,w.constants=s,w.storage=r,w.userService=l,w.localize=a,w.hasSignedIn=w.constants.SIGNINSTATUS.UNKNOWN,w.selectedUserType=w.constants.USER_TYPE.MSA,w.currentViewMode=w.constants.MENU_VIEWMODE.NONE,n.userType=w.constants.USER_TYPE.NONE,w.menuItems=[{id:"NewDocument",label:"CreateNewLabel",iconClass:"o365-Icon--circlePlus",viewMode:w.constants.MENU_VIEWMODE.NEW},{id:"OpenDocument",label:"OpenDocumentLabel",iconClass:"o365-Icon--folderOpen",viewMode:w.constants.MENU_VIEWMODE.OPEN},{id:"AccountInfo",label:"AccountLabel",iconClass:"o365-Icon--person2",viewMode:w.constants.MENU_VIEWMODE.ACCOUNT},{id:"Settings",label:"SettingsLabel",iconClass:"o365-Icon--gear",viewMode:w.constants.MENU_VIEWMODE.SETTINGS}],w.appLaunchers=[{id:"WordOnline",label:"WordOnlineAppName",imageSource:"../assets/word.png",url:w.constants.LINKS.APP.WORD},{id:"ExcelOnline",label:"ExcelOnlineAppName",imageSource:"../assets/excel.png",url:w.constants.LINKS.APP.EXCEL},{id:"PowerPointOnline",label:"PowerPointOnlineAppName",imageSource:"../assets/powerpoint.png",url:w.constants.LINKS.APP.POWERPOINT},{id:"OneNoteOnline",label:"OneNoteOnlineAppName",imageSource:"../assets/onenote.png",url:w.constants.LINKS.APP.ONENOTE},{id:"Sway",label:"SwayAppName",imageSource:"../assets/sway.png",url:w.constants.LINKS.APP.SWAY}],w.filePickers=[{id:w.constants.USER_TYPE.O365,label:"O365FilesLabel",fontClass:"o365-Icon--onedrive",isLocal:!1},{id:w.constants.USER_TYPE.MSA,label:"OneDriveFilesLabel",fontClass:"o365-Icon--onedrive",isLocal:!1},{id:"Local",label:"BrowseToOpenLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:w.isChrome,isEdge:!1},{id:w.constants.USER_TYPE.O365,label:"UploadToOneDriveBusinessLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:!1,isEdge:!w.isChrome},{id:w.constants.USER_TYPE.MSA,label:"UploadToOneDriveLabel",fontClass:"o365-Icon--desktop",isLocal:!0,isChrome:!1,isEdge:!w.isChrome}],o.ready(function(){e(function(){i.trackEvent("PopupPageLoad")})}),this.getSignInInfo=function(e){i.debug("PopupController.getSignInInfo(): Method start"),w.storage.get("refreshToken").then(function(n){e(Utilities.isNotUndefinedOrNull(n.refreshToken)?w.constants.SIGNINSTATUS.HASSIGNININFO:w.constants.SIGNINSTATUS.NONE)})},u()}angular.module("app.popup",[]).controller("PopupController",["$timeout","$scope","$q","$log","$document","constants","storage","userService","localize","notification",i]).directive("bindFileChange",e).directive("bindDragAndDrop",["$log",n]).directive("bindFileInputContainerClick",["constants","$log",t])}();