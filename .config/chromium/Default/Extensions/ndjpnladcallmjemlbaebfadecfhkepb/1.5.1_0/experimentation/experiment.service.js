!function(){"use strict";function e(e,r,i,n,t,o){function s(e){var i=r.defer();return l(e).then(function(r){return r?void f().then(function(r){i.resolve(r[e])}):(i.resolve(t.EXPERIMENTS[e].CONTROL),i.promise)}),i.promise}function f(){var e=r.defer();return Utilities.isNotUndefinedOrNull(U)?(e.resolve(U),e.promise):Utilities.isNotUndefinedOrNull(g)?(r.all([g]).then(function(){e.resolve(U)}),e.promise):(E().then(function(){e.resolve(U)}),e.promise)}function l(e){var n=r.defer(),t=function(e){return i.error(String.format("experimentService.experimentEnabled error: {0}",e)),n.resolve(!1),n.promise};return o.getUserType().then(function(r){return I.flightingDisabled(r)?(n.resolve(!1),n.promise):void n.resolve(!m(r,e))},t),n.promise}function u(e){return m(e)}function E(){var e=r.defer();g=e.promise;var s=function(r){return i.error(String.format("experimentService.setFlights error: {0}",r)),v(),e.resolve(),e.promise};return o.getUserType().then(function(r){return R=h[r],Utilities.isUndefinedOrNull(r)||r===n.USER_TYPE.NONE?s(t.ERROR.BAD_USER_TYPE):I.flightingDisabled(r)?(v(),e.resolve(),e.promise):void o.waitForUserInfo(r).then(function(i){if(Utilities.isNotUndefinedOrNull(i)&&Utilities.isNotUndefinedOrNull(i.flights))return U=i.flights,e.resolve(),e.promise;var n=a(r,i);d(n).then(function(n){c(n),i.flights=U,i.features=n,o.saveUserInfo(r,i),e.resolve()},s)},s)},s),e.promise}function a(e,r){return Utilities.isUndefinedOrNull(r)?t.DEFAULT_CLIENT_ID:Utilities.isNotUndefinedOrNull(r.cid)?r.cid:t.DEFAULT_CLIENT_ID}function d(n){var o=r.defer();if(Utilities.isUndefinedOrNull(n)||n===t.DEFAULT_CLIENT_ID)return i.error("experimentService.getFeatures: clientId is undefined, null, or empty"),o.reject(t.ERROR.NO_CLIENT_ID),o.promise;var s=O(T(n)),f={method:"GET",url:t.ENDPOINT,headers:{"X-MSEDGE-CLIENTID":s}};return e(f).success(function(e){Utilities.isNotUndefinedOrNull(e)&&Utilities.isNotUndefinedOrNull(e.Features)?o.resolve(e.Features):o.reject(t.ERROR.NO_FEATURES)}).error(function(e){o.reject(e)}),o.promise}function c(e){U={};for(var r in t.EXPERIMENTS)t.EXPERIMENTS.hasOwnProperty(r)&&N(e,r);p(e)}function N(e,r){var i=t.EXPERIMENTS[r];if(U[r]=i.CONTROL,i.ENABLED[R])for(var n in i.FLIGHTS)if(i.FLIGHTS.hasOwnProperty(n)&&e.indexOf(n)>-1){U[r]=i.FLIGHTS[n];break}}function v(){U={};for(var e in t.EXPERIMENTS)if(t.EXPERIMENTS.hasOwnProperty(e)){var r=t.EXPERIMENTS[e];U[e]=r.CONTROL}}function p(e){for(var r=[],n=0;n<e.length;++n){var t=e[n];S(t)&&r.push(t)}r.length>0&&i.error(String.format("ExP service returned invalid features: {0}",JSON.stringify(r)))}function S(e){for(var r in t.EXPERIMENTS)if(t.EXPERIMENTS.hasOwnProperty(r)){var i=t.EXPERIMENTS[r];if(i.FLIGHTS.hasOwnProperty(e))return!1}return!0}function m(e,r){if(e===n.USER_TYPE.NONE)return!0;var o=t.EXPERIMENTS.hasOwnProperty(r)?t.EXPERIMENTS[r].ENABLED:t.ENABLED,s=r||"all experiments",f=Utilities.getBrowserName().toLowerCase(),l=o.BROWSERS.toString().toLowerCase();if(l.indexOf(f)<0)return i.info(String.format("experimentService: experiment {0} is disabled for browser {1}. Experiment is only enabled for browsers {2}",s,f,l)),!0;var u=o[h[e]];return u||i.info(String.format("experimentService: experiment {0} is disabled for userType {1}",s,e)),!u}function T(e){var r,i,n="";for(i=0;i<e.length;i++)r=e.charCodeAt(i).toString(16),n+=("000"+r).slice(-4);return n}function O(e){return e.length>100?e.substring(0,100):e}var U=null,g=null,h={};h[n.USER_TYPE.MSA]="MSA",h[n.USER_TYPE.O365]="O365";var R,I={getFlight:s,getFlights:f,flightingDisabled:u,experimentEnabled:l};return I}angular.module("app.experimentation").factory("experimentService",["$http","$q","$log","constants","experimentConstants","userService",e])}();